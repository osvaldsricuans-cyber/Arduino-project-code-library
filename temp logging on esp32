#include <EEPROM.h>
#include "DHT.h"

// ----- DHT11 setup -----
#define DHTPIN 2
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// ----- EEPROM settings -----
#define EEPROM_SIZE 1024                 // Enough for 120 logs (8 bytes each)
const int MAX_LOGS = 120;               // Max number of readings stored
const float DAY_MARKER = -9999.0;       // Marks the end of a day

// ----- Timing -----
const unsigned long READ_INTERVAL = 2000UL; // 1 hour in ms
unsigned long lastReadTime = 0;

// ----- Logging -----
int logIndex = 0;
float tempSum = 0;
float humSum = 0;
int readingCount = 0;

// ----- Serial / display tracking -----
int Hour = 1;
bool Hstatus = true;
bool AVGstatus = true;

void setup() {
  Serial.begin(115200);
  dht.begin();

  EEPROM.begin(EEPROM_SIZE);       // Mandatory on ESP32
  logIndex = findLastLogIndex();   // Resume where left off

  Serial.println("Hourly DHT11 Logger (EEPROM based)");
  Serial.println("Send 'd' to dump logs, 'c' to clear memory, 'how' for instructions.");
}

void loop() {
  unsigned long currentMillis = millis();

  // ----- Take reading every hour -----
  if (currentMillis - lastReadTime >= READ_INTERVAL) {
    lastReadTime = currentMillis;

    float temp = dht.readTemperature();
    float hum  = dht.readHumidity();

    if (!isnan(temp) && !isnan(hum)) {
      logReading(temp, hum);
      tempSum += temp;
      humSum += hum;
      readingCount++;

      Serial.print("Logged: ");
      Serial.print(temp);
      Serial.print(" C  ");
      Serial.print(hum);
      Serial.println(" %");
    } else {
      Serial.println("Sensor error, skipping...");
    }

    // ----- After 24 hourly readings â†’ daily average -----
    if (readingCount >= 24) {
      float avgTemp = tempSum / 24.0;
      float avgHum  = humSum / 24.0;

      Serial.println("---- Daily Average ----");
      Serial.print("Temp: "); Serial.println(avgTemp);
      Serial.print("Hum:  "); Serial.println(avgHum);
      Serial.println("-----------------------");

      // Log average
      logReading(avgTemp, avgHum);

      // Log day marker
      logReading(DAY_MARKER, DAY_MARKER);

      // Reset counters
      tempSum = 0;
      humSum = 0;
      readingCount = 0;
    }
  }

  // ----- Serial command handling -----
  if (Serial.available()) {
    String command = Serial.readStringUntil('\n');
    command.trim(); // Remove spaces or line breaks

    if (command == "d") {
      dumpLogs();
    } 
    else if (command == "c") {
      clearEEPROM();
      Serial.println("EEPROM cleared!");
    } 
    else if (command == "how") {
      Serial.println("Instructions:");
      Serial.println(" - Send 'd' to dump log");
      Serial.println(" - Send 'c' to clear EEPROM");
      Serial.println(" - Send 'how' to show this message");
      Serial.println("Logging temperature and humidity every hour,");
      Serial.println("and averaging every 24 readings (1 day).");
    } 
    else {
      Serial.println("Unknown command. Type 'how' for help.");
    }
  }
}

// ----- EEPROM Logging Functions -----

void logReading(float temp, float hum) {
  if (logIndex + 2 > MAX_LOGS) {
    Serial.println("EEPROM full, overwriting oldest data.");
    logIndex = 0; // Circular buffer
  }

  EEPROM.put(logIndex * sizeof(float) * 2, temp);
  EEPROM.put(logIndex * sizeof(float) * 2 + sizeof(float), hum);
  EEPROM.commit();  // Required on ESP32
  logIndex++;
}

int findLastLogIndex() {
  for (int i = 0; i < MAX_LOGS; i++) {
    float t;
    EEPROM.get(i * sizeof(float) * 2, t);
    if (isnan(t)) return i;
  }
  return 0;
}

void dumpLogs() {
  Serial.println("---- EEPROM LOG DUMP ----");
  Hour = 1;
  Hstatus = true;
  AVGstatus = true;

  for (int i = 0; i < MAX_LOGS; i++) {
    float temp, hum;
    EEPROM.get(i * sizeof(float) * 2, temp);
    EEPROM.get(i * sizeof(float) * 2 + sizeof(float), hum);

    if (isnan(temp)) break;

    if (temp == DAY_MARKER && hum == DAY_MARKER) {
      Serial.println("=== END OF DAY ===");
      Hour = 1;
      Hstatus = true;
      AVGstatus = true;
    } else {
      Serial.print("Hour ");
      Serial.print(Hour);
      Serial.print(" | Temp: "); 
      Serial.print(temp);
      Serial.print(" C | Hum: ");
      Serial.print(hum);
      Serial.println(" %");

      if (Hour < 24 && Hstatus) {
        Hour++;
      } else if (AVGstatus) {
        Serial.println("AVG from Hour 1 to 24 above");
        AVGstatus = false;
      }
    }
  }

  Serial.println("---------------------------");
}

void clearEEPROM() {
  for (int i = 0; i < EEPROM_SIZE; i++) {
    EEPROM.write(i, 0xFF);
  }
  EEPROM.commit(); // Must commit on ESP32
}
